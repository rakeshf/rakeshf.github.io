<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Stock Movement Overview</title>
  <meta name="description"
    content="Interactive F&O Stock Dashboard to analyze option chain data, PCR, open interest, and signals like Long Unwinding, Short Covering. Supports filtering, dark mode, and data file selection." />
  <meta name="keywords"
    content="F&O dashboard, stock analysis, options dashboard, PCR, open interest, option chain, Long Unwinding, Short Covering, bullish sentiment, bearish sentiment, stock screener, OI data, nsepython" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="index, follow" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="icons8-rupee-48.png" rel="shortcut icon">
  <meta http-equiv="refresh" content="900">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-PB8VW32FTL"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-PB8VW32FTL');
  </script>
  <style>
    body {
      padding-bottom: 70px;
      background-color: #fff;
      color: #212529;
      transition: background-color 0.3s, color 0.3s;
    }

    .dark-mode {
      background-color: #121212;
      color: #e1e1e1;
    }

    .card {
      background-color: #fff;
      color: #212529;
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      cursor: default;
      position: relative;
      overflow: visible;
    }

    .dark-mode .card {
      background-color: #1e1e1e;
      color: #e1e1e1;
    }

    .card.expanded {
      transform: scale(1.02);
      z-index: 1100;
    }

    /* Expand button: top-right */
    .expand-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      z-index: 1200;
      padding: .25rem .4rem;
      line-height: 1;
    }

    .expand-btn i {
      font-size: 1rem;
    }

    .card-body {
      padding-top: 2.25rem;
    }

    /* leave space for the top-right button */
    td.signal-positive {
      color: #198754;
      font-weight: 400;
      font-size: small;
    }

    td.signal-negative {
      color: #dc3545;
      font-weight: 400;
      font-size: small;
    }

    td.signal-warning {
      color: #fd7e14;
      font-weight: 400;
      font-size: small;
    }

    td.build-balanced {
      color: #0d6efd;
      font-weight: 400;
      font-size: small;
    }

    td.build-long {
      color: #198754;
      font-weight: 400;
      font-size: small;
    }

    td.build-short {
      color: #dc3545;
      font-weight: 400;
      font-size: small;
    }

    td.oi-up {
      color: #198754;
      font-weight: 400;
      font-size: small;
    }

    td.oi-down {
      color: #dc3545;
      font-weight: 400;
      font-size: small;
    }

    td.oi-neutral {
      color: #6c757d;
      font-weight: 400;
      font-size: small;
    }

    td.text-secondary {
      color: #6c757d;
      font-weight: 400;
      font-size: small;
    }

    footer {
      background-color: #f8f9fa;
      color: #6c757d;
      transition: background-color 0.3s, color 0.3s;
    }

    .dark-mode footer {
      background-color: #121212;
      color: #999;
    }

    #darkModeToggle {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1300;
    }

    /* Make canvas area visually constrained so Chart.js can size correctly */
    .chart-wrapper {
      width: 100%;
      min-height: 180px;
      max-height: 340px;
      display: flex;
    }

    .card canvas {
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>

<body>

  <button id="darkModeToggle" class="btn btn-outline-primary">
    <i class="bi bi-moon-fill"></i> Dark Mode
  </button>

  <div class="container my-4">
    <h1 class="mb-4 text-center">ðŸš€ Stock Movement Overview</h1>
    <div class="row" id="gridContainer"></div>
  </div>

  <script>
    const container = document.getElementById('gridContainer');
    const darkModeToggle = document.getElementById('darkModeToggle');

    function updateToggleText() {
      darkModeToggle.innerHTML = document.body.classList.contains('dark-mode')
        ? '<i class="bi bi-sun-fill"></i> Light Mode'
        : '<i class="bi bi-moon-fill"></i> Dark Mode';
    }

    function applySavedMode() {
      if (localStorage.getItem('darkMode') === 'enabled') {
        document.body.classList.add('dark-mode');
      } else {
        document.body.classList.remove('dark-mode');
      }
      updateToggleText();
    }

    darkModeToggle.addEventListener('click', () => {
      const isDark = document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
      updateToggleText();
      loadDataAndRender();
    });

    function getSignalProps(signal) {
      if (!signal) return { icon: 'bi bi-question-circle', className: 'text-muted' };
      signal = signal.toLowerCase();
      if (signal.includes('long') || signal.includes('build-up') || signal.includes('bullish')) {
        return { icon: 'bi bi-arrow-up-circle-fill', className: 'signal-positive' };
      }
      if (signal.includes('short') || signal.includes('unwinding') || signal.includes('bearish')) {
        return { icon: 'bi bi-arrow-down-circle-fill', className: 'signal-negative' };
      }
      if (signal.includes('warning') || signal.includes('âš ')) {
        return { icon: 'bi bi-exclamation-triangle-fill', className: 'signal-warning' };
      }
      return { icon: 'bi bi-info-circle-fill', className: 'text-secondary' };
    }

    function getBuildSideProps(buildSide) {
      console.log('getBuildSideProps called with:', buildSide);
      if (!buildSide) return { className: 'text-muted' };
      buildSide = buildSide.toLowerCase();
      if (buildSide === 'balanced') return { className: 'build-balanced' };
      if (buildSide === 'long') return { className: 'build-long' };
      if (buildSide === 'short') return { className: 'build-short' };
      return { className: 'text-secondary' };
    }

    function getOiDirectionProps(direction) {
      if (!direction) return { icon: '', className: 'oi-neutral' };
      if (direction === 'â†‘') return { icon: 'bi bi-arrow-up', className: 'oi-up' };
      if (direction === 'â†“') return { icon: 'bi bi-arrow-down', className: 'oi-down' };
      return { icon: '', className: 'oi-neutral' };
    }

    function safeNumber(v) { return (typeof v === 'number' && !isNaN(v)) ? v : null; }

    function loadDataAndRender() {
      container.innerHTML = '';

      fetch('data/index.json?t=' + Date.now())
        .then(res => res.json())
        .then(fileList => Promise.all(
          fileList.slice().reverse().map(fileName =>
            fetch(fileName + '?t=' + Date.now()).then(r => r.json()).catch(() => [])
          )
        ))
        .then(allDataArrays => {
          const combined = allDataArrays.flat();
          if (combined.length === 0) {
            container.innerHTML = '<p class="text-danger">No data available to display.</p>';
            return;
          }
          // Group by symbol
          const grouped = combined.reduce((acc, entry) => {
            if (!entry || !entry.symbol) return acc;
            if (!acc[entry.symbol]) acc[entry.symbol] = [];
            acc[entry.symbol].push(entry);
            return acc;
          }, {});

          Object.entries(grouped).forEach(([symbol, entries], idx) => {
            // create column & card
            const col = document.createElement('div');
            col.className = 'col-12 col-md-6 col-lg-4 mb-4';
            const card = document.createElement('div');
            card.className = 'card shadow-sm h-100';
            card.style.position = 'relative';
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body d-flex flex-column';

            // top-right expand button (icon)
            const expandBtn = document.createElement('button');
            expandBtn.type = 'button';
            expandBtn.className = 'btn btn-sm btn-outline-secondary expand-btn';
            expandBtn.setAttribute('title', 'Expand');
            expandBtn.innerHTML = '<i class="bi bi-arrows-fullscreen"></i>'; // uses bootstrap icons
            // append button to card so it's positioned correctly
            card.appendChild(expandBtn);

            // Title

            // Build the title line
            // console.log('Processing symbol:', symbol, 'with entries:', entries[0]);
            var signalIndex = entries.length;
            //const symbol = entries[signalIndex - 1]?.symbol || 'N/A';
            const price = safeNumber(entries[signalIndex - 1]?.price);
            const changePct = safeNumber(entries[signalIndex - 1]?.price_change_pct);
            const cardTitle = document.createElement('h5');
            cardTitle.className = 'card-title text-primary';
            cardTitle.innerHTML = `
              <span class="symbol">${symbol}</span>
              <small class="${changePct > 0 ? 'text-success' : changePct < 0 ? 'text-danger' : 'text-muted'} text-secondary">
                â‚¹${price !== null ? price.toFixed(2) : 'N/A'} 
                (${changePct !== null ? (changePct > 0 ? 'â†‘ ' : changePct < 0 ? 'â†“ ' : '') + changePct.toFixed(2) + '%' : 'N/A'})
              </small>
            `;
            cardBody.appendChild(cardTitle);


            // const title = document.createElement('h5');
            // title.className = 'card-title text-primary';
            // title.textContent = symbol;
            // cardBody.appendChild(title);

            // Chart wrapper & canvas
            const chartWrapper = document.createElement('div');
            chartWrapper.className = 'chart-wrapper mb-2 flex-grow-1';
            const canvas = document.createElement('canvas');
            canvas.id = 'chart-' + idx;
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            chartWrapper.appendChild(canvas);
            cardBody.appendChild(chartWrapper);

            // Signal & meta
            const table = document.createElement('table');
            table.className = 'table table-sm mb-0 text-secondary';

            const tbody = document.createElement('tbody');

            // Helper function to add a row with two cells
            function addRow(label, value, className = '', labelClass = 'text-secondary') {
              const tr = document.createElement('tr');
              const tdLabel = document.createElement('td');
              tdLabel.textContent = label;
              tdLabel.className = labelClass; // style only the label cell
              const tdValue = document.createElement('td');
              tdValue.innerHTML = value;
              tdValue.className = className;
              tr.appendChild(tdLabel);
              tr.appendChild(tdValue);
              tbody.appendChild(tr);
            }

            // Signal
            const { icon: signalIcon, className: signalClass } = getSignalProps(entries[signalIndex - 1]?.signal);
            addRow('Signal', `<i class="${signalIcon} me-2"></i> ${entries[signalIndex - 1]?.signal || 'N/A'}`, signalClass);

            // Build Side
            const { className: buildClass } = getBuildSideProps(entries[signalIndex - 1]?.build_side);
            addRow('Build Side', entries[signalIndex - 1]?.build_side || 'N/A', buildClass);

            // CE OI Change %
            const ceOiChangePct = safeNumber(entries[signalIndex - 1]?.ce_oi_change_pct);
            addRow(
              'CE OI Change %',
              ceOiChangePct !== null ? ceOiChangePct.toFixed(2) + '%' : 'N/A',
              ceOiChangePct > 0 ? 'oi-up' : ceOiChangePct < 0 ? 'oi-down' : 'oi-neutral'
            );

            // PE OI Change %
            const peOiChangePct = safeNumber(entries[signalIndex - 1]?.pe_oi_change_pct);
            addRow(
              'PE OI Change %',
              peOiChangePct !== null ? peOiChangePct.toFixed(2) + '%' : 'N/A',
              peOiChangePct > 0 ? 'oi-up' : peOiChangePct < 0 ? 'oi-down' : 'oi-neutral'
            );

            // OI Direction
            const { icon: oiIcon, className: oiClass } = getOiDirectionProps(entries[signalIndex - 1]?.oi_direction);
            addRow('OI Direction', `<i class="${oiIcon}"></i>`, oiClass);

            // Append table
            table.appendChild(tbody);
            cardBody.appendChild(table);
            card.appendChild(cardBody);
            col.appendChild(card);
            container.appendChild(col);


            // Prepare labels and datasets (keep nulls so Chart.js handles gaps)
            const labels = entries.map(e => {
              if (!e?.timestamp) return '';
              return new Date(e.timestamp).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true, timeZone: 'Asia/Kolkata' });
            });
            const ceData = entries.map(e => safeNumber(e.total_ce_oi));
            const peData = entries.map(e => safeNumber(e.total_pe_oi));

            // create chart and store reference on canvas for later resize
            const chart = new Chart(canvas.getContext('2d'), {
              type: 'line',
              data: {
                labels,
                datasets: [
                  { label: 'Total CE OI', data: ceData, borderColor: '#fd7e14', backgroundColor: '#fd7e1488', fill: false, tension: 0.3, pointRadius: 3 },
                  { label: 'Total PE OI', data: peData, borderColor: '#6f42c1', backgroundColor: '#6f42c188', fill: false, tension: 0.3, pointRadius: 3 }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'nearest', intersect: false },
                scales: {
                  y: { beginAtZero: true, title: { display: true, text: 'Open Interest (OI)' }, grid: { color: document.body.classList.contains('dark-mode') ? '#444' : '#e9ecef' } },
                  x: { title: { display: true, text: 'Timestamp (IST)' }, grid: { color: document.body.classList.contains('dark-mode') ? '#444' : '#e9ecef' } }
                },
                plugins: {
                  legend: { position: 'top', labels: { color: document.body.classList.contains('dark-mode') ? '#eee' : '#212529' } },
                  tooltip: {
                    callbacks: {
                      label: ctx => (ctx.parsed.y === null || ctx.parsed.y === undefined) ? 'N/A' : ctx.parsed.y.toLocaleString(),
                      title: ctx => {
                        const ts = entries[ctx[0].dataIndex]?.timestamp;
                        return ts ? new Date(ts).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata', dateStyle: 'medium', timeStyle: 'short', hour12: true }) : '';
                      }
                    }
                  }
                }
              }
            });
            // attach chart ref for resizing later
            canvas._oiChart = chart;

            // Expand button behavior (only this button toggles expand)
            expandBtn.addEventListener('click', (evt) => {
              evt.stopPropagation();
              // collapse other expanded cards
              document.querySelectorAll('.card.expanded').forEach(otherCard => {
                if (otherCard === card) return;
                otherCard.classList.remove('expanded');
                const otherCol = otherCard.closest('[class*="col-"]');
                if (otherCol) otherCol.className = 'col-12 col-md-6 col-lg-4 mb-4';
                const otherBtn = otherCard.querySelector('.expand-btn');
                if (otherBtn) otherBtn.innerHTML = '<i class="bi bi-arrows-fullscreen"></i>';
                const c = otherCard.querySelector('canvas');
                if (c && c._oiChart) {
                  // give layout a moment to settle
                  setTimeout(() => c._oiChart.resize(), 220);
                }
              });

              // toggle current
              const isNowExpanded = !card.classList.contains('expanded');
              if (isNowExpanded) {
                card.classList.add('expanded');
                col.className = 'col-12 col-md-6 col-lg-12 mb-4';
                expandBtn.innerHTML = '<i class="bi bi-fullscreen-exit"></i>';
              } else {
                card.classList.remove('expanded');
                col.className = 'col-12 col-md-6 col-lg-4 mb-4';
                expandBtn.innerHTML = '<i class="bi bi-arrows-fullscreen"></i>';
              }
              // resize chart after layout changes
              setTimeout(() => {
                if (canvas && canvas._oiChart) canvas._oiChart.resize();
              }, 220);
            });
          });
        })
        .catch(err => {
          console.error('Error:', err);
          container.innerHTML = `<p class="text-danger">Error loading data: ${err.message}</p>`;
        });
    }

    applySavedMode();
    loadDataAndRender();
  </script>

  <footer class="bg-light text-center text-muted py-3 mt-4"
    style="position: fixed; bottom: 0; width: 100%; z-index: 1000;">
    <div class="container">
      <small>Disclaimer: This data is for informational purposes only. Not financial advice. Use at your own
        risk.</small>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>