<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8">
  <title>F&O Stock Dashboard</title>
  <meta name="description" content="Interactive F&O Stock Dashboard to analyze option chain data, PCR, open interest, and signals like Long Unwinding, Short Covering. Supports filtering, dark mode, and data file selection.">
  <meta name="keywords" content="F&O dashboard, stock analysis, options dashboard, PCR, open interest, option chain, Long Unwinding, Short Covering, bullish sentiment, bearish sentiment, stock screener, OI data, nsepython">
  <meta name="author" content="Rakesh Falke">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Optional CSS for custom elements */
body {
  transition: background-color 0.3s ease, color 0.3s ease;
}
    body[data-bs-theme="dark"] {
      background-color: #121212;
      color: white;
    }

    body[data-bs-theme="light"] {
      background-color: #f8f9fa;
      color: #212529;
    }

    .card {
      border-radius: 1rem;
    }

    [data-bs-theme="dark"] .card {
      background-color: #1e1e1e;
    }

    [data-bs-theme="light"] .card {
      background-color: #ffffff;
    }

    .material-icons-outlined {
      vertical-align: middle;
      font-size: 20px;
    }

    select.form-select {
      background-color: inherit;
      color: inherit;
      border: 1px solid #444;
    }

    .form-check-input {
      cursor: pointer;
    }

    .badge {
      font-size: 0.8rem;
    }
  </style>
</head>
<body class="p-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>F&O Stock Dashboard</h2>
<button class="btn btn-outline-secondary ms-2" id="modeToggle" title="Toggle Theme">
  <span class="material-icons-outlined" id="modeIcon">dark_mode</span>
</button>
  </div>
<div class="row row-cols-1">
  <div class="mb-3">
    <label for="sentimentFilter" class="form-label">Filter by Sentiment</label>
    <select class="form-select w-auto" id="sentimentFilter">
      <option>All</option>
      <option>Bullish</option>
      <option>Bearish</option>
      <option>Neutral</option>
    </select>
  </div>
    <div class="mb-3">
        <label for="fileSelector" class="form-label">Select Data File</label>
        <select class="form-select w-auto" id="fileSelector">
        <!-- Options will be populated dynamically -->
    </select>
</div>

  <div class="row row-cols-1 row-cols-md-3 g-4" id="cardContainer"></div>

  <script>
  const getSentimentColor = sentiment => {
    if (sentiment === "Bullish") return "bg-success";
    if (sentiment === "Bearish") return "bg-danger";
    if (sentiment === "Neutral") return "bg-secondary";
    return "bg-dark";
  };

  const getSignalColor = signal => {
    if (signal.includes("Short Covering")) return "bg-warning text-dark";
    if (signal.includes("Long Unwinding")) return "bg-info text-dark";
    return "bg-light text-dark";
  };

const renderCards = (data) => {
  const container = document.getElementById("cardContainer");
  container.innerHTML = "";

  data.forEach(stock => {
    const card = document.createElement("div");
    card.className = "col";

    const priceIcon = stock.price_direction === "↑"
      ? `<span class="material-icons-outlined text-success">trending_up</span>`
      : `<span class="material-icons-outlined text-danger">trending_down</span>`;

    const oiIcon = stock.oi_direction === "↑"
      ? `<span class="material-icons-outlined text-success">north</span>`
      : `<span class="material-icons-outlined text-danger">south</span>`;

    const signalBadge = `<span class="badge ${getSignalColor(stock.signal)}">${stock.signal}</span>`;
    const sentimentBadge = `<span class="badge ${getSentimentColor(stock.sentiment)} text-white">${stock.sentiment}</span>`;

    card.innerHTML = `
      <div class="card h-100 shadow">
        <div class="card-body">
          <h5 class="card-title">${stock.symbol}</h5>
          <p class="card-text mb-1">
            ${priceIcon}
            ₹${stock.price.toFixed(2)} (${stock.price_direction} ${stock.price_change_pct.toFixed(2)}%)
          </p>
          <p class="card-text mb-1">
            Prev Close: ₹${stock.previous_close.toFixed(2)}
          </p>
          <p class="card-text mb-1">
            <span class="material-icons-outlined text-info">equalizer</span>
            CE OI: <strong>${stock.total_ce_oi.toLocaleString()}</strong>,
            PE OI: <strong>${stock.total_pe_oi.toLocaleString()}</strong>
          </p>
          <p class="card-text mb-1">
            ${oiIcon} OI: ${stock.oi_direction} ${stock.oi_change_pct.toFixed(2)}%
          </p>
          <p class="card-text mb-1">
            CE Δ: ${stock.ce_oi_change_pct.toFixed(2)}% &nbsp;
            PE Δ: ${stock.pe_oi_change_pct.toFixed(2)}%
          </p>
          <p class="card-text mb-1">
            PCR: <strong>${stock.pcr.toFixed(2)}</strong>
          </p>
          <p class="card-text mb-1">
            Build Side: <strong>${stock.build_side}</strong>
          </p>
          <p class="mb-1">
            ${sentimentBadge} ${signalBadge}
          </p>
          ${stock.conflict ? `<p class="text-danger fw-bold mt-1">⚠️ Conflicting Signal</p>` : ""}
        </div>
      </div>
    `;
    container.appendChild(card);
  });
};


  // Load available files into dropdown (assumes data/index.json contains array of filenames)
fetch("data/index.json")
  .then(res => res.json())
  .then(fileList => {
    const select = document.getElementById("fileSelector");
    fileList.forEach(file => {
      const option = document.createElement("option");
      option.value = file;
      option.textContent = file;
      console.log("Adding file option:", file);
      select.appendChild(option);
    });

    // Load the first file initially
    if (fileList.length) loadAndRenderData(fileList[0]);

    // Reload dashboard on file change
    select.addEventListener("change", () => {
      loadAndRenderData(select.value);
    });
  })
  .catch(err => {
    console.error("Error loading file list:", err);
    document.getElementById("cardContainer").innerHTML = `<p class="text-danger">Error loading file list: ${err.message}</p>`;
  });

// Load + render cards from a file
const loadAndRenderData = (filename) => {
  fetch(`data/${filename}`)
    .then(response => {
      if (!response.ok) throw new Error("Failed to fetch data");
      return response.json();
    })
    .then(data => {
      renderCards(data);

      // Filter handler
      const filter = document.getElementById("sentimentFilter");
      if (filter) {
        filter.onchange = () => {
          const selected = filter.value;
          const filtered = selected === "All" ? data : data.filter(item => item.sentiment === selected);
          renderCards(filtered);
        };
      }
    })
    .catch(error => {
      document.getElementById("cardContainer").innerHTML = `<p class="text-danger">Error loading data: ${error.message}</p>`;
      console.error("Fetch error:", error);
    });
};

</script>
<script>
  const modeToggle = document.getElementById("modeToggle");
  const modeIcon = document.getElementById("modeIcon");

  const setTheme = (theme) => {
    document.documentElement.setAttribute("data-bs-theme", theme);
    localStorage.setItem("theme", theme);
    modeIcon.textContent = theme === "dark" ? "light_mode" : "dark_mode";
  };

  const toggleTheme = () => {
    const current = document.documentElement.getAttribute("data-bs-theme") || "light";
    setTheme(current === "dark" ? "light" : "dark");
  };

  modeToggle.addEventListener("click", toggleTheme);

  // On load: apply saved theme
  const saved = localStorage.getItem("theme") || "light";
  setTheme(saved);
</script>
</body>
</html>
