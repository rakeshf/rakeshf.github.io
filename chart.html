<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Combined Stocks OI Charts</title>
  <meta name="description" content="Interactive dashboard showing Open Interest (OI) charts for multiple stocks using combined JSON data." />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="index, follow" />

  <!-- Open Graph -->
  <meta property="og:title" content="Combined Stocks OI Charts" />
  <meta property="og:description" content="Interactive dashboard showing Open Interest (OI) charts for multiple stocks." />
  <meta property="og:type" content="website" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .card canvas {
      width: 100% !important;
      height: 220px !important;
    }
  </style>
</head>
<body>

<div class="container my-4">
  <h1 class="mb-4 text-center">Combined Stock Open Interest (OI) Charts</h1>
  <div class="row" id="gridContainer"></div>
  <pre id="debugLog" style="max-height: 150px; overflow-y: auto; background: #eee; padding: 10px; font-size: 12px;"></pre>
</div>

<script>
  const container = document.getElementById('gridContainer');
  const debugLog = document.getElementById('debugLog');

  function log(msg) {
    console.log(msg);
    debugLog.textContent += msg + '\n';
  }

  fetch('data/index.json?t=' + Date.now())
    .then(res => {
      if (!res.ok) throw new Error('Failed to load index.json');
      return res.json();
    })
    .then(fileList => {
      log(`index.json loaded, files to fetch: ${fileList.length}`);
      return Promise.all(
        fileList.map(fileName =>
          fetch(fileName + '?t=' + Date.now())
            .then(r => {
              if (!r.ok) throw new Error(`Failed to load ${fileName}`);
              return r.json();
            })
            .then(json => {
              if (!Array.isArray(json)) {
                log(`Warning: ${fileName} does not contain array, ignoring.`);
                return [];
              }
              log(`Loaded ${fileName} with ${json.length} entries.`);
              return json;
            })
            .catch(e => {
              log(`Error loading ${fileName}: ${e.message}`);
              return [];
            })
        )
      );
    })
    .then(allDataArrays => {
      const combined = allDataArrays.flat();
      log(`Total combined entries: ${combined.length}`);

      if (combined.length === 0) {
        container.innerHTML = '<p class="text-danger">No data available to display.</p>';
        return;
      }

      // Group by symbol
      const grouped = combined.reduce((acc, entry) => {
        if (!entry.symbol) return acc;
        if (!acc[entry.symbol]) acc[entry.symbol] = [];
        acc[entry.symbol].push(entry);
        return acc;
      }, {});

      log(`Symbols found: ${Object.keys(grouped).join(', ')}`);

      Object.entries(grouped).forEach(([symbol, entries], idx) => {
        const col = document.createElement('div');
        col.className = 'col-12 col-md-6 col-lg-4 mb-4';

        const card = document.createElement('div');
        card.className = 'card shadow-sm h-100';

        const cardBody = document.createElement('div');
        cardBody.className = 'card-body d-flex flex-column';

        const title = document.createElement('h5');
        title.className = 'card-title text-primary';
        title.textContent = symbol;
        cardBody.appendChild(title);

        const canvas = document.createElement('canvas');
        canvas.id = 'chart-' + idx;
        canvas.style.flexGrow = '1';
        cardBody.appendChild(canvas);

        card.appendChild(cardBody);
        col.appendChild(card);
        container.appendChild(col);

        const labels = entries.map((_, i) => `#${i + 1}`);

        const datasets = [
          {
            label: 'Total CE OI',
            data: entries.map(e => e.total_ce_oi),
            borderColor: '#fd7e14',
            backgroundColor: '#fd7e1488',
            fill: false,
            tension: 0.3,
            pointRadius: 3
          },
          {
            label: 'Total PE OI',
            data: entries.map(e => e.total_pe_oi),
            borderColor: '#6f42c1',
            backgroundColor: '#6f42c188',
            fill: false,
            tension: 0.3,
            pointRadius: 3
          }
        ];

        new Chart(canvas.getContext('2d'), {
          type: 'line',
          data: { labels, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'nearest', intersect: false },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: 'Open Interest (OI)' }
              },
              x: {
                title: { display: true, text: 'Record # (Time order)' }
              }
            },
            plugins: {
              legend: { position: 'top' },
              tooltip: {
                callbacks: {
                  label: ctx => ctx.parsed.y.toLocaleString()
                }
              }
            }
          }
        });
      });
    })
    .catch(err => {
      console.error('Error:', err);
      container.innerHTML = `<p class="text-danger">Error loading data: ${err.message}</p>`;
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
